<ion-content class="progreso-page ion-padding">

  <!-- ✅ SECCIÓN 2 — MEDALLAS DEL USUARIO -->
  <section class="seccion">
    <h2 class="titulo-seccion">Tus Medallas</h2>

    <div class="medallas-grid" *ngIf="medalla.length > 0; else sinMedallas">
      <div class="medalla-card" *ngFor="let m of medalla">
        <img [src]="m.icono" alt="{{ m.nombre }}">
        <h4>{{ m.nombre }}</h4>
      </div>
    </div>

    <ng-template #sinMedallas>
      <p class="texto-vacio">Aún no has conseguido ninguna medalla.</p>
    </ng-template>
  </section>

  <!-- ✅ SECCIÓN 1 — ENTRENAMIENTOS ACTUALES -->
  <section class="seccion entrenamientos">

    <div class="entrenamiento-item"
        *ngFor="let plan of planes"
        [class.completado]="plan.completado"
        (click)="abrirDetalle(plan)">
        
      <div class="plan-icon">
        <ion-icon name="barbell-outline"></ion-icon>
      </div>

      <div class="info">
        <h3 class="titulo-plan">{{ plan.plan.nombre }}</h3>

        <p class="subtitulo-plan">
          Día: {{ getDiaSemana(plan.plan.dia_semana) }}
        </p>

        <div class="estado-plan" [class.ready]="plan.completado">
          <ion-icon [name]="plan.completado ? 'checkmark-circle' : 'time-outline'"></ion-icon>
          <span>{{ plan.completado ? 'Completado' : 'En progreso' }}</span>
        </div>
      </div>

    </div>

  </section>

  <!-- ✅ SECCIÓN 3 — GRÁFICOS HISTÓRICOS -->
  <section class="seccion">
    <h2 class="titulo-seccion">Historial de Entrenamientos</h2>

    <canvas #graficoProgreso></canvas>
  </section>

  <!-- ✅ FAB para crear plan -->
  <ion-fab 
    vertical="bottom" 
    horizontal="end" 
    slot="fixed" 
    class="fab-above-tabbar"
    *ngIf="canCrear"
  >
    <ion-fab-button (click)="crearPlan()">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- ✅ MODAL DETALLE ENTRENAMIENTO (DISEÑO PRO + FUNCIONAL) -->
  <ion-modal [isOpen]="modalAbierto" (didDismiss)="cerrarModal()">
    <ng-template>

      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>{{ planSeleccionado?.plan?.nombre }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarModal()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">

        <h3>Día: {{ getDiaSemana(planSeleccionado?.plan?.dia_semana) }}</h3>

        <ion-list *ngIf="ejerciciosPlan.length > 0; else noEj">

          <div class="ejercicio-card" *ngFor="let detalle of ejerciciosPlan">

            <div class="info">
              <h3>{{ detalle.ejercicio.nombre }}</h3>

              <p class="detalle">
                {{ detalle.series }} × {{ detalle.repeticiones }}
                <span *ngIf="detalle.peso_kg"> | {{ detalle.peso_kg }} kg</span>
              </p>

              <div class="estado" [class.completado]="detalle.completado">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                <span>
                  {{ detalle.completado ? 'Completado' : 'Pendiente' }}
                </span>
              </div>
            </div>

            <div class="acciones">
              <ion-button
                color="success"
                class="btn-accion"
                [disabled]="detalle.completado"
                (click)="marcarEjercicio(detalle)"
              >
                <ion-icon name="checkmark-outline"></ion-icon>
              </ion-button>

              <ion-button
                color="danger"
                class="btn-accion"
                (click)="eliminarEjercicio(planSeleccionado.plan.id, detalle.ejercicio.id)"
              >
                <ion-icon name="trash-outline"></ion-icon>
              </ion-button>
            </div>

          </div>

        </ion-list>

        <ng-template #noEj>
          <p class="text-center">Este entrenamiento aún no tiene ejercicios.</p>
        </ng-template>

      </ion-content>

    </ng-template>
  </ion-modal>

</ion-content>
